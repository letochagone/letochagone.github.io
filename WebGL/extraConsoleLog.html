<!doctype html>
<html>

<body>
	<canvas id="canvas"></canvas>

	<script>
		"use strict";

		let vertex=`
			attribute vec2 a_position;
			void main() {
				gl_Position = vec4(a_position,0.0,1.0);
				gl_PointSize = 1.0;
			}
		`;
		let fragment = `
			#ifdef GL_FRAGMENT_PRECISION_HIGH
  				precision highp float;
			#else
  				precision mediump float;
			#endif

			void main() {

				vec2 grid = floor(gl_FragCoord.xy/vec2(1.0,2.0)-vec2(5.,5.));
				//               1    2    3   4   5    6   7   8   ....W
			    // grid.x =     -5   -4   -3  -2  -1    0  +1  +2   ....W-6  
			    // grid.y =     -5   -5   -5  -5  -5   -5   5   5   ....5

			    // grid.x =     -5   -4   -3  -2  -1    0  +1  +2   ....W-6  
			    // grid.y =     -5   -5   -5  -5  -5   -5   5   5   ....5

			    // grid.x =     -5   -4   -3  -2  -1    0  +1  +2   ....W-6  
			    // grid.y =     -5   -5   -5  -5  -5   -5   5   5   ....5

			    // grid.x =     -5   -4   -3  -2  -1    0  +1  +2   ....W-6  
			    // grid.y =     -4   -4   -4  -4  -4   -4   4   4   ....4



			   	float datai = floor(fract(gl_FragCoord.y/2.0)*2.0);
			   	// 0 0 0 ...0 (gl.canvas.wdith fois)
			   	// 1 1 1 ...1 (gl.canvas.wdith fois)
			   	// 0 0 0 ...0 (gl.canvas.width fois)
			   	// 1 1 1 ...1 (gl.canvas.width fois)
			   	// ...
			    // ...
			   	// gl.canvas.height lignes

				float nb= (gl_FragCoord.x-0.5)+1.0;

				float res2=mod(nb,3.0);

				gl_FragColor=vec4(gl_FragCoord.xy,666.0,666.0);

			}
		`;
		let canvas = document.querySelector("#canvas");
		let gl = canvas.getContext("webgl");
		gl.getExtension('OES_texture_float');

		gl.canvas.width=4;
		gl.canvas.height=4;

	
		let program   = gl.createProgram();
		const vertexShader = gl.createShader(gl.VERTEX_SHADER);
		const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
		gl.shaderSource(vertexShader, vertex);
		gl.shaderSource(fragmentShader, fragment);
		gl.compileShader(vertexShader);
		gl.compileShader(fragmentShader);
		gl.attachShader(program, vertexShader);
		gl.attachShader(program, fragmentShader);
		gl.linkProgram(program);

		gl.useProgram(program);


		//LE BUFFER des "a_position"
		const positionBuffer = gl.createBuffer();
		// Bind it to ARRAY_BUFFER (think of it as ARRAY_BUFFER = positionBuffer)
		gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
		// fill it with a 2 triangles that cover clipspace
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
			-1, -1,  // first triangle
			 1, -1,
			-1,  1,
			-1,  1,  // second triangle
			 1, -1,
			 1,  1,
		]),
		gl.STATIC_DRAW);
 

		let targetTexture = gl.createTexture () ;
		gl.bindTexture  ( gl.TEXTURE_2D, targetTexture ) ;
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
		gl.texImage2D (gl.TEXTURE_2D, 0, gl.RGBA, gl.canvas.width, gl.canvas.height, 0, gl.RGBA,gl.FLOAT, null);

		const fb= gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
		// attach the texture as the first color attachment
		const attachmentPoint = gl.COLOR_ATTACHMENT0;
		gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, targetTexture, 0);

		gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
		gl.clearColor(0, 0, 0, 1);
		gl.clear(gl.COLOR_BUFFER_BIT);

		{
			const positionAttributeLocation = gl.getAttribLocation(program, "a_position");
			gl.enableVertexAttribArray(positionAttributeLocation);
			gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
			gl.vertexAttribPointer( positionAttributeLocation,
				2,          // 2 components per iteration
				gl.FLOAT,   // the data is 32bit floats
				false,      // don't normalize the data
				0,          // 0 = move forward size * sizeof(type) each iteration to get the next position
				0          // start at the beginning of the buffer
			);
		}

		gl.drawArrays(gl.TRIANGLES, 0, 6);

		var data = new Float32Array(4 * gl.canvas.width * gl.canvas.height);
		gl.readPixels(0, 0, gl.canvas.width, gl.canvas.height, gl.RGBA, gl.FLOAT, data);

		for ( let j=0 ; j < gl.canvas.height ; j++ ) {
			let ligne="";
			for ( let i=0 ; i < gl.canvas.width ; i++) {
				ligne=ligne+"("+data[i*4 +j*gl.canvas.width*4 ]+" , "+data[i*4+1+ j*gl.canvas.width*4]+ ")";
			}
			console.log(ligne);
		}
	</script>
</body>
</html>
